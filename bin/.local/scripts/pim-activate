#!/bin/zsh

# PIM Role Activation Script
# Uses az login for authentication and provides interactive role selection

# Colors for output
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
GRAY='\033[0;37m'
WHITE='\033[0;37m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Default values
DEFAULT_REASON="Admin tasks required"

# Function to print colored output
print_message() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}"
}

# Function to print section headers
print_header() {
    echo -e "\n${BOLD}${CYAN}$1${NC}"
    echo -e "${GRAY}$(printf '=%.0s' {1..50})${NC}"
}

# Get all subscriptions for name resolution
get_subscriptions() {
    az account list --query '[].{id: id, name: name}' -o json 2>/dev/null
}

# Check if Azure CLI is installed and logged in
check_prerequisites() {
    if ! command -v az &> /dev/null; then
        print_message $RED "Error: Azure CLI not found. Please install Azure CLI first."
        exit 1
    fi

    if ! command -v jq &> /dev/null; then
        print_message $RED "Error: jq not found. Please install jq first."
        exit 1
    fi

    # Check if logged in
    if ! az account show &> /dev/null; then
        print_message $YELLOW "Not logged in to Azure. Running 'az login'..."
        az login
        if [[ $? -ne 0 ]]; then
            print_message $RED "Login failed. Exiting."
            exit 1
        fi
    fi
}

# Get eligible PIM roles
get_eligible_roles() {
    print_message $CYAN "Querying eligible PIM roles..." >&2
    
    # Get subscription information for name resolution
    print_message $GRAY "  Fetching subscription information..." >&2
    local subscriptions=$(get_subscriptions)
    
    # Get Azure Resource roles
    print_message $GRAY "  Checking Azure Resource roles..." >&2
    local azure_roles=$(az rest --method GET --url 'https://management.azure.com/providers/Microsoft.Authorization/roleEligibilityScheduleInstances?api-version=2020-10-01&$filter=asTarget()' 2>/dev/null | jq -c '[.value[]? | {
        type: "Azure Resource",
        roleName: .properties.expandedProperties.roleDefinition.displayName,
        scope: .properties.scope,
        roleDefinitionId: .properties.roleDefinitionId,
        principalId: .properties.principalId,
        memberType: .properties.memberType,
        roleEligibilityScheduleId: .properties.roleEligibilityScheduleId
    } | select(.roleName != null and .roleName != "")]' 2>/dev/null)

    # Get Entra ID roles (Azure AD roles)
    print_message $GRAY "  Checking Entra ID roles..." >&2
    local entra_roles=$(az rest --method GET --url 'https://graph.microsoft.com/beta/roleManagement/directory/roleEligibilitySchedules?$expand=roleDefinition' --resource https://graph.microsoft.com 2>/dev/null | jq -c '[.value[]? | {
        type: "Entra ID",
        roleName: .roleDefinition.displayName,
        scope: (.directoryScopeId // "/"),
        roleDefinitionId: .roleDefinitionId,
        principalId: .principalId,
        memberType: "Direct",
        roleEligibilityScheduleId: .id
    } | select(.roleName != null and .roleName != "")]' 2>/dev/null)
    
    # Combine roles and enrich with subscription names
    local all_roles="[]"
    if [[ -n "$azure_roles" && "$azure_roles" != "null" && "$azure_roles" != "[]" ]]; then
        all_roles="$azure_roles"
    fi
    if [[ -n "$entra_roles" && "$entra_roles" != "null" && "$entra_roles" != "[]" ]]; then
        if [[ "$all_roles" == "[]" ]]; then
            all_roles="$entra_roles"
        else
            all_roles=$(echo "$all_roles" "$entra_roles" | jq -s '.[0] + .[1]' 2>/dev/null)
        fi
    fi
    
    # Enrich roles with subscription names
    print_message $GRAY "  Enriching with subscription names..." >&2
    local enriched_roles=$(echo "$all_roles" | jq --argjson subs "$subscriptions" '
        map(
            if (.scope | contains("/subscriptions/")) then
                . as $role |
                ($role.scope | capture("/subscriptions/(?<subId>[^/]+)").subId) as $subId |
                ($subs | map(select(.id == $subId)) | first) as $sub |
                if $sub then
                    $role + {subscriptionName: $sub.name, subscriptionId: $subId}
                else
                    $role + {subscriptionName: "Unknown", subscriptionId: $subId}
                end
            else
                .
            end
        )
    ' 2>/dev/null)
    
    echo "$enriched_roles"
}

# Display available roles
display_roles() {
    local roles_json=$1
    print_header "Available PIM Roles"
    
    local role_count=$(echo "$roles_json" | jq '. | length' 2>/dev/null || echo "0")
    
    if [[ "$role_count" -eq 0 ]]; then
        print_message $YELLOW "No eligible PIM roles found."
        exit 0
    fi

    local counter=1
    echo "$roles_json" | jq -c '.[]' | while read -r role; do
        local role_type=$(echo "$role" | jq -r '.type')
        local role_name=$(echo "$role" | jq -r '.roleName')
        local scope=$(echo "$role" | jq -r '.scope')
        local subscription_name=$(echo "$role" | jq -r '.subscriptionName // empty')
        
        # Build display scope with subscription name
        local display_scope="$scope"
        if [[ "$scope" == *"/subscriptions/"* ]]; then
            if [[ -n "$subscription_name" && "$subscription_name" != "null" ]]; then
                if [[ "$scope" == *"/resourceGroups/"* ]]; then
                    local rg_name=$(echo "$scope" | sed 's|.*/resourceGroups/||' | sed 's|/.*||')
                    display_scope="$subscription_name → RG: $rg_name"
                else
                    display_scope="$subscription_name"
                fi
            else
                # Fallback to original display logic
                if [[ "$scope" == *"/resourceGroups/"* ]]; then
                    display_scope="RG: $(echo "$scope" | sed 's|.*/resourceGroups/||')"
                else
                    display_scope="Subscription"
                fi
            fi
        elif [[ "$scope" == *"/managementGroups/"* ]]; then
            display_scope="MG: $(echo "$scope" | sed 's|.*/managementGroups/||')"
        elif [[ "$scope" == "/" ]]; then
            display_scope="Directory"
        fi
        
        print_message $WHITE "$counter. [$role_type] $role_name ($display_scope)"
        ((counter++))
    done
}

# Get user selection
get_user_selection() {
    local roles_json=$1
    local total_roles=$(echo "$roles_json" | jq '. | length')
    
    echo >&2
    print_message $CYAN "Enter role numbers separated by commas (e.g., 1,3,5) or 'all' for all roles:" >&2
    read "selection?Selection: " >&2
    
    if [[ -z "$selection" ]]; then
        print_message $RED "No selection made. Exiting." >&2
        exit 0
    fi

    if [[ "$selection" == "all" || "$selection" == "ALL" ]]; then
        echo "$roles_json"
    else
        # Parse comma-separated numbers using array approach
        local selected_roles="[]"
        local num_array
        local num
        
        # Use parameter expansion to create array
        num_array=($(echo "$selection" | tr ',' ' '))
        
        for num in "${num_array[@]}"; do
            num=$(echo "$num" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')  # trim whitespace
            if [[ "$num" =~ ^[0-9]+$ ]] && [[ "$num" -ge 1 ]] && [[ "$num" -le "$total_roles" ]]; then
                local index=$((num - 1))
                local role=$(echo "$roles_json" | jq ".[$index]")
                if [[ "$role" != "null" ]]; then
                    selected_roles=$(echo "$selected_roles" | jq ". + [$role]")
                fi
            else
                print_message $RED "Invalid selection: $num" >&2
                exit 1
            fi
        done
        echo "$selected_roles"
    fi
}

# Get justification from user
get_justification() {
    echo >&2
    print_message $CYAN "Enter justification for role activation:" >&2
    read "justification?Reason [$DEFAULT_REASON]: " >&2
    
    if [[ -z "$justification" ]]; then
        justification="$DEFAULT_REASON"
    fi
    
    echo "$justification"
}

# Activate a single role
activate_role() {
    local role_json=$1
    local justification=$2
    
    local role_type=$(echo "$role_json" | jq -r '.type')
    local role_name=$(echo "$role_json" | jq -r '.roleName')
    local role_definition_id=$(echo "$role_json" | jq -r '.roleDefinitionId')
    local principal_id=$(echo "$role_json" | jq -r '.principalId')
    local scope=$(echo "$role_json" | jq -r '.scope')
    local role_eligibility_schedule_id=$(echo "$role_json" | jq -r '.roleEligibilityScheduleId')
    
    # Get current user ID for self-activation
    local current_user_id=$(az ad signed-in-user show --query 'id' -o tsv)
    
    print_message $YELLOW "Activating [$role_type] $role_name..."
    
    if [[ "$role_type" == "Entra ID" ]]; then
        # Activate Entra ID role
        local request_body=$(jq -n --arg action "selfActivate" \
                               --arg principalId "$current_user_id" \
                               --arg roleDefinitionId "$role_definition_id" \
                               --arg directoryScopeId "$scope" \
                               --arg justification "$justification" \
                               --arg startDateTime "$(date -u +"%Y-%m-%dT%H:%M:%S.000000+00:00")" \
                               '{
                                 action: $action,
                                 principalId: $principalId,
                                 roleDefinitionId: $roleDefinitionId,
                                 directoryScopeId: $directoryScopeId,
                                 justification: $justification,
                                 scheduleInfo: {
                                   startDateTime: $startDateTime,
                                   expiration: {
                                     type: "AfterDuration",
                                     duration: "PT1H"
                                   }
                                 }
                               }')
        
        local result=$(az rest --method POST \
                              --url "https://graph.microsoft.com/beta/roleManagement/directory/roleAssignmentScheduleRequests" \
                              --resource https://graph.microsoft.com \
                              --body "$request_body" 2>/dev/null)
        local exit_code=$?
    else
        # Activate Azure Resource role
        local guid=$(uuidgen | tr '[:upper:]' '[:lower:]')
        local request_body=$(jq -n --arg roleDefinitionId "$role_definition_id" \
                               --arg principalId "$current_user_id" \
                               --arg justification "$justification" \
                               --arg linkedRoleEligibilityScheduleId "$role_eligibility_schedule_id" \
                               --arg startDateTime "$(date -u +"%Y-%m-%dT%H:%M:%S.000000+00:00")" \
                               '{
                                 properties: {
                                   roleDefinitionId: $roleDefinitionId,
                                   principalId: $principalId,
                                   requestType: "SelfActivate",
                                   linkedRoleEligibilityScheduleId: $linkedRoleEligibilityScheduleId,
                                   justification: $justification,
                                   scheduleInfo: {
                                     startDateTime: $startDateTime,
                                     expiration: {
                                       type: "AfterDuration",
                                       duration: "PT1H"
                                     }
                                   }
                                 }
                               }')
        
        local api_url="https://management.azure.com$scope/providers/Microsoft.Authorization/roleAssignmentScheduleRequests/$guid?api-version=2020-10-01"
        
        local result=$(az rest --method PUT \
                              --url "$api_url" \
                              --body "$request_body" 2>/dev/null)
        local exit_code=$?
    fi
    
    if [[ $exit_code -eq 0 ]] && [[ -n "$result" ]]; then
        # Check if the result contains an error
        local error_code=$(echo "$result" | jq -r '.error.code // empty' 2>/dev/null)
        if [[ -n "$error_code" ]]; then
            print_message $RED "✗ Failed to activate: $role_name"
            print_message $RED "  Error: $error_code - $(echo "$result" | jq -r '.error.message // "Unknown error"' 2>/dev/null)"
        else
            local activation_status=$(echo "$result" | jq -r '.properties.status // empty' 2>/dev/null)
            if [[ "$activation_status" == "Provisioned" ]]; then
                print_message $GREEN "✓ Successfully activated: $role_name"
            else
                print_message $YELLOW "⚠ Activation requested: $role_name (Status: $activation_status)"
            fi
        fi
    elif [[ $exit_code -eq 0 ]]; then
        print_message $GREEN "✓ Successfully activated: $role_name"
    else
        print_message $RED "✗ Failed to activate: $role_name"
    fi
}

# Main function
main() {
    print_header "Azure PIM Role Activation"
    
    check_prerequisites
    
    local roles_json=$(get_eligible_roles)
    
    display_roles "$roles_json"
    
    local selected_roles=$(get_user_selection "$roles_json")
    
    local justification=$(get_justification)
    
    print_header "Activating Selected Roles"
    print_message $CYAN "Justification: $justification"
    print_message $CYAN "Duration: 1h"
    echo
    
    echo "$selected_roles" | jq -c '.[]' | while read -r role; do
        activate_role "$role" "$justification"
        sleep 1
    done
    
    echo
    print_message $GREEN "Role activation process completed!"
    print_message $GRAY "Note: It may take a few minutes for role activations to take effect."
}

# Run main function
main "$@"